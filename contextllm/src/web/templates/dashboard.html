<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContextLLM ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .video-section {
            flex: 0 0 400px;
        }
        
        .video-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            font-size: 14px;
        }
        
        .live-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            animation: livePulse 1.5s infinite;
        }
        
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .video-placeholder {
            display: none;
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
        
        .video-placeholder .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .stats-section {
            flex: 1;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .stat-card.critical .value { color: #dc3545; }
        .stat-card.high .value { color: #fd7e14; }
        .stat-card.medium .value { color: #ffc107; }
        .stat-card.low .value { color: #28a745; }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .results-header h2 {
            font-size: 18px;
        }
        
        .results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .result-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #28a745;
            transition: all 0.3s;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-card.critical { 
            border-left-color: #dc3545; 
            background: rgba(220, 53, 69, 0.15);
            box-shadow: 0 0 30px rgba(220, 53, 69, 0.3);
            border: 2px solid #dc3545;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 0 60px rgba(220, 53, 69, 0.6); }
        }
        
        .result-card.high { border-left-color: #fd7e14; background: rgba(253, 126, 20, 0.1); }
        .result-card.medium { border-left-color: #ffc107; }
        .result-card.low { border-left-color: #28a745; }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .result-time {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }
        
        .result-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .result-badge.critical { background: #dc3545; }
        .result-badge.high { background: #fd7e14; }
        .result-badge.medium { background: #ffc107; color: #000; }
        .result-badge.low { background: #28a745; }
        
        .result-text {
            font-size: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .result-text::before {
            content: 'ğŸ¤ ';
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .result-section {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        
        .result-section h4 {
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }
        
        .result-section p {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .emergency-alert {
            background: linear-gradient(90deg, #dc3545, #c82333);
            color: #fff;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            display: none;
            animation: alertPulse 1s infinite;
        }
        
        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .emergency-alert.show {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .emergency-alert .icon {
            font-size: 32px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            .video-section {
                flex: none;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ ContextLLM ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <div class="subtitle">ì‹¤ì‹œê°„ ë©€í‹°ëª¨ë‹¬ ìƒí™© ë¶„ì„</div>
    </div>
    
    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">ì—°ê²°ë¨</span>
        </div>
        <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
    </div>
    
    <div class="container">
        <div class="emergency-alert" id="emergencyAlert">
            <div class="icon">ğŸš¨</div>
            <div>
                <strong>ê¸´ê¸‰ ìƒí™© ê°ì§€!</strong>
                <p id="emergencyText"></p>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì»¨í…ì¸ : ë¹„ë””ì˜¤ + í†µê³„ -->
        <div class="main-content">
            <!-- ë¹„ë””ì˜¤ ì„¹ì…˜ (ë¼ì´ë¸Œ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) -->
            <div class="video-section" id="videoSection" style="display: none;">
                <div class="video-container">
                    <div class="video-header">
                        <span>ğŸ“¹ ì‹¤ì‹œê°„ ì˜ìƒ</span>
                        <span class="live-badge">LIVE</span>
                    </div>
                    <img id="videoFeed" src="/video_feed" alt="Video Feed" />
                    <div class="video-placeholder" id="videoPlaceholder">
                        <div class="icon">ğŸ“·</div>
                        <p>ì¹´ë©”ë¼ ì—°ê²° ëŒ€ê¸°ì¤‘...</p>
                    </div>
                </div>
            </div>
            
            <!-- í†µê³„ ì„¹ì…˜ -->
            <div class="stats-section">
                <div class="stats">
                    <div class="stat-card">
                        <div class="value" id="totalCount">0</div>
                        <div class="label">ì´ ë¶„ì„</div>
                    </div>
                    <div class="stat-card critical">
                        <div class="value" id="criticalCount">0</div>
                        <div class="label">ê¸´ê¸‰</div>
                    </div>
                    <div class="stat-card high">
                        <div class="value" id="highCount">0</div>
                        <div class="label">ë†’ìŒ</div>
                    </div>
                    <div class="stat-card medium">
                        <div class="value" id="mediumCount">0</div>
                        <div class="label">ì¤‘ê°„</div>
                    </div>
                    <div class="stat-card low">
                        <div class="value" id="lowCount">0</div>
                        <div class="label">ì •ìƒ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-header">
            <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
        </div>
        
        <div class="results" id="results">
            <div class="empty-state">
                <div class="icon">ğŸ‘‚</div>
                <p>ìŒì„±ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</p>
                <p style="font-size: 12px; margin-top: 10px;">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        let results = [];
        let videoEnabled = false;
        
        // í†µê³„ ì¹´ìš´íŠ¸
        let stats = { total: 0, critical: 0, high: 0, medium: 0, low: 0 };
        
        // ë¹„ë””ì˜¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateVideoStatus(enabled) {
            videoEnabled = enabled;
            const videoSection = document.getElementById('videoSection');
            const videoFeed = document.getElementById('videoFeed');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            
            if (enabled) {
                videoSection.style.display = 'block';
                videoFeed.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                // ìŠ¤íŠ¸ë¦¼ ìƒˆë¡œê³ ì¹¨
                videoFeed.src = '/video_feed?' + new Date().getTime();
            } else {
                videoSection.style.display = 'none';
            }
        }
        
        socket.on('connect', () => {
            document.getElementById('connectionDot').style.background = '#28a745';
            document.getElementById('connectionStatus').textContent = 'ì—°ê²°ë¨';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connectionDot').style.background = '#dc3545';
            document.getElementById('connectionStatus').textContent = 'ì—°ê²° ëŠê¹€';
        });
        
        socket.on('video_status', (data) => {
            updateVideoStatus(data.enabled);
        });
        
        socket.on('init_results', (data) => {
            results = data;
            updateStats();
            renderResults();
        });
        
        socket.on('new_result', (data) => {
            results.unshift(data);
            if (results.length > 50) results = results.slice(0, 50);
            
            updateStats();
            renderResults();
            
            // ê¸´ê¸‰ ì•Œë¦¼
            if (data.is_emergency || data.level === 'critical') {
                showEmergencyAlert(data);
            }
        });
        
        socket.on('clear_results', () => {
            results = [];
            stats = { total: 0, critical: 0, high: 0, medium: 0, low: 0 };
            updateStats();
            renderResults();
        });
        
        function updateStats() {
            stats = { total: results.length, critical: 0, high: 0, medium: 0, low: 0 };
            results.forEach(r => {
                if (r.level === 'critical') stats.critical++;
                else if (r.level === 'high') stats.high++;
                else if (r.level === 'medium') stats.medium++;
                else stats.low++;
            });
            
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('criticalCount').textContent = stats.critical;
            document.getElementById('highCount').textContent = stats.high;
            document.getElementById('mediumCount').textContent = stats.medium;
            document.getElementById('lowCount').textContent = stats.low;
        }
        
        function renderResults() {
            const container = document.getElementById('results');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ‘‚</div>
                        <p>ìŒì„±ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        <p style="font-size: 12px; margin-top: 10px;">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = results.map(r => `
                <div class="result-card ${r.level}">
                    <div class="result-header">
                        <span class="result-time">${r.timestamp}</span>
                        <span class="result-badge ${r.level}">${r.is_emergency ? 'ğŸš¨ ê¸´ê¸‰' : r.urgency_level}</span>
                    </div>
                    ${r.is_emergency ? `
                        <div style="background: #dc3545; color: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-weight: bold; text-align: center;">
                            ğŸš¨ ê¸´ê¸‰ ìƒí™© ê°ì§€ - ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”!
                        </div>
                    ` : ''}
                    <div class="result-text">${r.transcribed_text || '(ìŒì„± ì—†ìŒ)'}</div>
                    <div class="result-grid">
                        <div class="result-section">
                            <h4>ğŸ” ìƒí™© ë¶„ì„</h4>
                            <p><strong>${r.situation_type}</strong></p>
                            <p>${r.situation_description}</p>
                        </div>
                        <div class="result-section">
                            <h4>ğŸ¬ ì˜ìƒ ë‚´ìš©</h4>
                            <p>${r.video_description}</p>
                        </div>
                        <div class="result-section">
                            <h4>ğŸ˜Š ê°ì • ìƒíƒœ</h4>
                            <p>${r.emotion}</p>
                            <p style="color: rgba(255,255,255,0.5); font-size: 12px;">ìŒì„±-ì˜ìƒ ì¼ì¹˜: ${r.voice_video_match}</p>
                        </div>
                        <div class="result-section">
                            <h4>ğŸ’¡ ê¶Œì¥ ì¡°ì¹˜</h4>
                            <p>${r.recommended_action}</p>
                        </div>
                    </div>
                    ${r.is_emergency ? `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(220,53,69,0.3); border: 2px solid #dc3545; border-radius: 8px;">
                            <strong style="color: #ff6b7a;">ğŸš¨ ê¸´ê¸‰ íŒë‹¨ ê·¼ê±°:</strong>
                            <p style="margin-top: 5px; color: rgba(255,255,255,0.95);">${r.emergency_reason}</p>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function showEmergencyAlert(data) {
            const alert = document.getElementById('emergencyAlert');
            document.getElementById('emergencyText').textContent = 
                `${data.transcribed_text} - ${data.emergency_reason || data.situation_description}`;
            alert.classList.add('show');
            
            // 5ì´ˆ í›„ ìˆ¨ê¹€
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
            
            // ì†Œë¦¬ ì•Œë¦¼ (ë¸Œë¼ìš°ì € ì§€ì› ì‹œ)
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸš¨ ê¸´ê¸‰ ìƒí™© ê°ì§€', {
                    body: data.transcribed_text,
                    icon: 'ğŸš¨'
                });
            }
        }
        
        function clearResults() {
            fetch('/api/clear').then(() => {
                document.getElementById('emergencyAlert').classList.remove('show');
            });
        }
        
        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
